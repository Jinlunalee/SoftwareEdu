<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mycompany.webapp.dao.IEnrollRepository">

	<select id="getEnrollList" resultType="EnrollVO">
		SELECT  enroll_id AS "enrollId", 
				e.subject_id AS "subjectId", 
				e.subject_seq AS "subjectSeq", 
				e.student_id AS "studentId", 
				name AS "name", 
        		s.subject_title AS "subjectTitle", 
				e.state_cd AS "stateCd", 
				complete_hours AS "completeHours", 
				e.reg_id AS "regId", 
				e.reg_dt AS "regDt", 
				e.modi_id AS "modiId", 
				e.modi_dt AS "modiDt", 
				e.del_yn AS "delYn", 
				cancel_rs_etc AS "cancelRsEtc", 
        		start_time AS "startTime", 
        		end_time AS "endTime", 
        		start_day AS "startDay", 
        		end_day AS "endDay" 
		FROM ENROLL e 
		LEFT OUTER JOIN STUDENT t 
		ON e.student_id = t.student_id 
        LEFT OUTER JOIN OPEN o 
        ON e.subject_id = o.subject_id AND e.subject_seq = o.subject_seq 
        LEFT OUTER JOIN SUBJECT s 
        ON e.subject_id = s.subject_id 
        WHERE NOT (e.del_yn ='Y')
	</select>
	
	<select id="getRatio" parameterType="map" resultType="string">
		SELECT ROUND(complete_hours/hours * 100) 
		FROM ENROLL e, SUBJECT s 
		WHERE e.subject_id = s.subject_id AND student_id = #{studentId} AND e.subject_id = #{subjectId} AND subject_seq = #{subjectSeq} 
	</select>
	
	<select id="getHours" parameterType="string" resultType="int">
		SELECT complete_hours 
		FROM ENROLL 
		WHERE enroll_id = #{enrollId}
	</select>
	
	<select id="getCancelList" resultType="CommonCodeVO">
		SELECT comn_cd AS "comnCd", 
		comn_cd_title AS "comnCdTitle" 
		FROM COMMON_CODE 
		WHERE comn_cd = 'CXL04' OR comn_cd = 'CXL05' 
		OR comn_cd = 'CXL06' OR comn_cd = 'CXL07'
	</select>
	
	<select id="getStudentList" parameterType="StudentVO" resultType="StudentVO">
		SELECT student_id AS "studentId", 
				name AS "name", 
				birth AS "birth", 
				email AS "email", 
				phone AS "phone" 
		FROM STUDENT 
		WHERE 
		<choose>
			<when test="type != null and type.equals('name')">
				name = #{keyword}
			</when>
			<when test="type != null and type.equals('studentId')">
				student_id = #{keyword}
			</when>
		</choose>
	</select>
	
	<select id="getOpenList" parameterType="OpenVO" resultType="OpenVO">
		<choose>
			<when test="subCor != null and subCor.equals('subject')">
				SELECT o.subject_id AS "subjectId", 
						subject_seq AS "subjectSeq", 
						subject_title AS "subjectTitle", 
						o.course_id AS "courseId", 
						course_title AS "courseTitle",
						start_day AS "startDay", 
						end_day AS "endDay", 
						start_time AS "startTime", 
						end_time AS "endTime", 
						recruit_start_day AS "recruitStartDay", 
						recruit_end_day AS "recruitEndDay", 
						recruit_people AS "recruitPeople" 
				FROM OPEN o 
				LEFT OUTER JOIN SUBJECT s 
				ON o.subject_id = s.subject_id 
				LEFT OUTER JOIN COURSE c 
				ON o.course_id = c.course_id 
				WHERE
				(o.subject_id=#{kw} OR
				REPLACE(subject_title, ' ', '') LIKE '%'||#{kw}||'%') AND o.course_id is NULL
			</when>
			<when test="subCor != null and subCor.equals('course')">
			    SELECT 
			        o.course_id AS "courseId", 
			        course_title AS "courseTitle",
			        min(start_day) AS "startDay", 
			        max(end_day) AS "endDay", 
			        min(recruit_start_day) AS "recruitStartDay", 
			        max(recruit_end_day) AS "recruitEndDay", 
			        max(recruit_people) AS "recruitPeople" 
			    FROM OPEN o 
			    LEFT OUTER JOIN COURSE c 
			    ON o.course_id = c.course_id 
			    GROUP BY (o.course_id, course_title) 
			    HAVING o.course_id=#{kw} OR replace(course_title, ' ', '') LIKE '%'||#{kw}||'%'
			</when>
		</choose>
	</select>
	
	<select id="getMaxEnrollId" resultType="int">
		SELECT MAX((SUBSTR(enroll_id, 5, 4))) 
		FROM ENROLL
	</select>
	
	<select id="getSearchList" parameterType="map" resultType="EnrollVO">
		SELECT rnum, 
			"enrollId", 
		    "subjectId", 
		    "subjectSeq", 
		    "subjectTitle", 
		    "courseId", 
		    "courseTitle", 
		    "studentId", 
		    "name", 
		    "stateCd", 
		    "completeHours", 
		    "regId", 
		    "regDt", 
		    "modiId", 
		    "modiDt", 
		    "delYn", 
		    "cancelRsEtc", 
		    "startTime", 
		    "endTime", 
		    "startDay", 
		    "endDay" 
		FROM (
			SELECT 
			rownum as rnum,
			"enrollId", 
		    "subjectId", 
		    "subjectSeq", 
		    "subjectTitle", 
		    "courseId", 
		    "courseTitle", 
		    "studentId", 
		    "name",  
		    "stateCd", 
		    "completeHours", 
		    "regId", 
		    "regDt", 
		    "modiId", 
		    "modiDt", 
		    "delYn", 
		    "cancelRsEtc", 
		    "startTime", 
		    "endTime", 
		    "startDay", 
		    "endDay"
		FROM (
			SELECT  enroll_id AS "enrollId", 
				e.subject_id AS "subjectId", 
				e.subject_seq AS "subjectSeq", 
				s.subject_title AS "subjectTitle", 
				c.course_id AS "courseId", 
                c.course_title AS "courseTitle", 
				e.student_id AS "studentId", 
				name AS "name",  
				e.state_cd AS "stateCd", 
				complete_hours AS "completeHours", 
				e.reg_id AS "regId", 
				e.reg_dt AS "regDt", 
				e.modi_id AS "modiId", 
				e.modi_dt AS "modiDt", 
				e.del_yn AS "delYn", 
				cancel_rs_etc AS "cancelRsEtc", 
        		start_time AS "startTime", 
        		end_time AS "endTime", 
        		start_day AS "startDay", 
        		end_day AS "endDay"
		FROM ENROLL e 
		LEFT OUTER JOIN STUDENT t 
		ON e.student_id = t.student_id 
        LEFT OUTER JOIN OPEN o 
        ON e.subject_id = o.subject_id AND e.subject_seq = o.subject_seq 
        LEFT OUTER JOIN SUBJECT s 
        ON e.subject_id = s.subject_id 
        LEFT OUTER JOIN COURSE c 
        ON c.course_id = o.course_id 
		WHERE NOT (e.del_yn ='Y')  
			<if test='applyStartDay != null and applyEndDay != null'>
				AND e.reg_dt BETWEEN #{applyStartDay} AND #{applyEndDay}
			</if>
			<if test='student != null and student.equals("sdName")'>
				AND name = #{keyword1} 
			</if>
			<if test='student != null and student.equals("sdId")'>
				AND e.student_id = #{keyword1} 
			</if>
			<if test='course != null and course.equals("sj")'>
				AND s.subject_title = #{keyword2} OR REPLACE(s.subject_title, ' ', '') LIKE '%' || #{keyword2} || '%'
			</if>
			<if test='course != null and course.equals("cs")'>
				AND c.course_title = #{keyword2} OR REPLACE(c.course_title, ' ', '') LIKE '%' || #{keyword2} || '%'
			</if>
			<if test='state != null and state.equals("apply")'>
				AND e.state_cd = 'ERL01' 
			</if>
			<if test='state != null and state.equals("applyCancel")'>
				AND e.state_cd = 'ERL02' 
			</if>
			<if test='state != null and state.equals("expect")'>
				AND e.state_cd = 'ERL03' 
			</if>
			<if test='state != null and state.equals("progress")'>
				AND e.state_cd = 'ERL04' 
			</if>
			<if test='state != null and state.equals("cancel")'>
				AND e.state_cd = 'ERL05' 
			</if>
			<if test='state != null and state.equals("complete")'>
				AND e.state_cd = 'ERL06' 
			</if>
				)
			WHERE rownum &lt;= #{endRowNo}
			)
			WHERE rnum &gt;= #{startRowNo}
	</select>

	<select id="getCountSearchRow" parameterType="EnrollVO" resultType="int">
		SELECT count(*) 
		FROM ENROLL e 
		LEFT OUTER JOIN STUDENT t 
		ON e.student_id = t.student_id 
        LEFT OUTER JOIN OPEN o 
        ON e.subject_id = o.subject_id AND e.subject_seq = o.subject_seq 
        LEFT OUTER JOIN SUBJECT s 
        ON e.subject_id = s.subject_id 
        LEFT OUTER JOIN COURSE c 
        ON c.course_id = o.course_id 
		WHERE NOT (e.del_yn ='Y') 
			<if test='hid != null and hid.equals("a")'>
				AND 1 = 1 
			</if>
			<if test='applyStartDay != null and applyEndDay != null'>
				AND e.reg_dt BETWEEN #{applyStartDay} AND #{applyEndDay}
			</if>
			<if test='student != null and student.equals("sdName")'>
				AND name = #{keyword1} 
			</if>
			<if test='student != null and student.equals("sdId")'>
				AND e.student_id = #{keyword1} 
			</if>
			<if test='course != null and course.equals("sj")'>
				AND s.subject_title = #{keyword2} OR REPLACE(s.subject_title, ' ', '') LIKE '%' || #{keyword2} || '%'
			</if>
			<if test='course != null and course.equals("cs")'>
				AND c.course_title = #{keyword2} OR REPLACE(c.course_title, ' ', '') LIKE '%' || #{keyword2} || '%'
			</if>
			<if test='state != null and state.equals("apply")'>
				AND e.state_cd = 'ERL01' 
			</if>
			<if test='state != null and state.equals("applyCancel")'>
				AND e.state_cd = 'ERL02' 
			</if>
			<if test='state != null and state.equals("expect")'>
				AND e.state_cd = 'ERL03' 
			</if>
			<if test='state != null and state.equals("progress")'>
				AND e.state_cd = 'ERL04' 
			</if>
			<if test='state != null and state.equals("cancel")'>
				AND e.state_cd = 'ERL05' 
			</if>
			<if test='state != null and state.equals("complete")'>
				AND e.state_cd = 'ERL06' 
			</if>
	</select>
	
	
	
	
	
	<update id="clickCancel" parameterType="map">
		UPDATE ENROLL 
		SET state_cd = 'ERL05' 
		WHERE student_id = #{studentId} AND subject_id = #{subjectId} AND subject_seq = #{subjectSeq}
	</update>
	
	<update id="clickDelete" parameterType="map">
		UPDATE ENROLL 
		SET del_yn = 'Y' 
		WHERE student_id = #{studentId} AND subject_id = #{subjectId} AND subject_seq = #{subjectSeq}
	</update>
	
	<update id="clickDeleteEnrollByOpen" parameterType="map">
		UPDATE ENROLL 
		SET del_yn = 'Y' 
		WHERE subject_id = #{subjectId} AND subject_seq = #{subjectSeq}
	</update>
	
	<update id="addHours" parameterType="map">
		UPDATE ENROLL 
		SET complete_hours = complete_hours + #{addHours} 
		WHERE student_id = #{studentId} AND subject_id = #{subjectId} AND subject_seq = #{subjectSeq}
	</update>
	
	<update id="updateCancelRsCd" parameterType="map">
		UPDATE ENROLL 
		SET cancel_rs_cd = #{cancelRsCd}, cancel_rs_etc = #{cancelRsEtc} 
		WHERE student_id = #{studentId} AND subject_id = #{subjectId} AND subject_seq = #{subjectSeq}
	</update>
	
	<update id="approval" parameterType="map">
		UPDATE ENROLL 
		SET state_cd = 'ERL03' 
		WHERE student_id = #{studentId} AND subject_id = #{subjectId} AND subject_seq = #{subjectSeq}
	</update>
	
	<insert id="addEnroll" parameterType="map">
		INSERT INTO ENROLL 
		(enroll_id, subject_id, subject_seq, student_id, state_cd, 
		complete_hours, reg_id, reg_dt, modi_id, modi_dt, 
		del_yn, cancel_rs_cd, cancel_rs_etc) 
		VALUES ('ENRL0' || #{maxEnrollId}, #{subjectId}, #{subjectSeq}, #{studentId}, 'ERL03', 0, 'mgr1', '20230102', NULL, NULL, 'N', NULL, NULL)
	</insert>
	
	<select id="getSubjectCountByCourse" parameterType="String" resultType="int">
		SELECT count(subject_id)
		FROM open
		WHERE course_id=#{courseId}
	</select>
	
	<select id="getSubjectInfoByCourse" parameterType="String" resultType="OpenVO">
		select 
		    subject_id as "subjectId",
		    subject_seq as "subjectSeq"
		from open
		where course_id = #{courseId}
	</select>

</mapper>